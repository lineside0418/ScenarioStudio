<!DOCTYPE html>
<html lang="ja" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Scenario Editor - Pro</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tailwind Config for Custom Colors/Fonts -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        apple: {
                            50: '#f5f5f7',
                            100: '#e8e8ed',
                            200: '#d2d2d7',
                            300: '#86868b',
                            400: '#6e6e73',
                            500: '#1d1d1f',
                            600: '#121212', // Dark mode bg
                            700: '#1c1c1e', // Dark mode card
                            800: '#2c2c2e', // Dark mode hover
                            blue: '#0071e3',
                            red: '#ff3b30',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar for sleek look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #d2d2d7;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #424245;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #86868b;
        }
        
        /* Glassmorphism utilities */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dark .glass {
            background: rgba(28, 28, 30, 0.85);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Inputs transition */
        input, select, textarea {
            transition: all 0.2s ease;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in {
            animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>
<body class="bg-apple-50 text-apple-500 dark:bg-apple-600 dark:text-apple-100 h-screen overflow-hidden selection:bg-apple-blue selection:text-white transition-colors duration-300">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons Helper (Phosphor Icons Wrapper) ---
        const Icon = ({ name, weight = "regular", className = "" }) => (
            <i className={`ph ph-${name} ${className}`} style={{ fontWeight: weight === 'bold' ? 700 : 400 }}></i>
        );

        // --- Constants & Options ---
        const POSITIONS = [
            { value: '', label: 'None' },
            { value: 'center', label: 'Center' },
            { value: 'left_2', label: 'Left (2 chars)' },
            { value: 'right_2', label: 'Right (2 chars)' },
            { value: 'left_3', label: 'Left (3 chars)' },
            { value: 'right_3', label: 'Right (3 chars)' },
            { value: 'left_4', label: 'Left (4 chars)' },
            { value: 'right_4', label: 'Right (4 chars)' },
            { value: 'middle_left_4', label: 'Middle Left (4 chars)' },
            { value: 'middle_right_4', label: 'Middle Right (4 chars)' },
        ];

        const TIMES = [
            { value: '', label: 'None' },
            { value: 'morning', label: 'Morning' },
            { value: 'noon', label: 'Noon' },
            { value: 'afternoon', label: 'Afternoon' },
            { value: 'night', label: 'Night' },
        ];

        const LIGHTS = [
            { value: '', label: 'None' },
            { value: 'lighton', label: 'Light On' },
            { value: 'lightoff', label: 'Light Off' },
            { value: 'lightleft', label: 'Light Left' },
            { value: 'lightright', label: 'Light Right' },
        ];
        
        const TYPES = [
            { value: 'text', label: 'Text' },
            { value: 'choice', label: 'Choice' },
        ];

        // --- Default Data Structure ---
        const createEmptyScenario = (index = 0) => ({
            _uuid: crypto.randomUUID(),
            id: { route: "C", chapter: "1", scene: "1", number: String(index + 1).padStart(3, '0') }, // Default: C / 1 / 1 / 001
            type: "text", // Default: text
            characterId: "", // Talker ID
            displayName: "", // Talker Name
            standings: [], // New: Array of standing characters
            text: "",
            choices: [],
            bgm: "",
            se: "",
            bg: { location: "", time: "", detail: "", light: "" }, // Default: all empty
            seconds: 5, // Default: 5
            transition: "",
            next_id: { route: "", chapter: "", scene: "", number: "" }
        });

        const STORAGE_KEY = 'novel_scenario_data_v7'; // Version bump for structure change

        // --- Components ---

        // 1. UI Primitives
        const Field = ({ label, children, className = "" }) => (
            <div className={`flex flex-col gap-1.5 ${className}`}>
                <label className="text-xs font-semibold uppercase tracking-wider text-apple-400 dark:text-apple-300 pl-1">{label}</label>
                {children}
            </div>
        );

        const Input = ({ value, onChange, placeholder, type = "text", className = "" }) => (
            <input
                type={type}
                value={value}
                onChange={e => onChange(e.target.value)}
                placeholder={placeholder}
                className={`w-full bg-white dark:bg-apple-800 border border-gray-200 dark:border-white/5 focus:border-apple-blue dark:focus:border-apple-blue focus:ring-4 focus:ring-apple-blue/10 rounded-xl px-4 py-2.5 text-sm outline-none shadow-sm dark:shadow-none transition-all ${className}`}
            />
        );

        const Select = ({ value, onChange, options, className = "" }) => (
            <div className="relative">
                <select
                    value={value}
                    onChange={e => onChange(e.target.value)}
                    className={`w-full bg-white dark:bg-apple-800 border border-gray-200 dark:border-white/5 focus:border-apple-blue dark:focus:border-apple-blue focus:ring-4 focus:ring-apple-blue/10 rounded-xl px-4 py-2.5 text-sm outline-none shadow-sm dark:shadow-none appearance-none transition-all cursor-pointer ${className}`}
                >
                    {options.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-apple-400">
                    <Icon name="caret-down" weight="bold" />
                </div>
            </div>
        );

        // 2. Custom Modal
        const Modal = ({ isOpen, onClose, title, children, actions }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4" style={{zIndex: 9999}}>
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm animate-fade-in" onClick={onClose}></div>
                    <div className="bg-white dark:bg-apple-700 w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-scale-in relative z-10 flex flex-col">
                        <div className="p-6 text-center">
                            <h3 className="text-lg font-bold mb-2 text-apple-500 dark:text-white">{title}</h3>
                            <div className="text-sm text-gray-500 dark:text-gray-300">
                                {children}
                            </div>
                        </div>
                        <div className="grid grid-flow-col border-t border-gray-200 dark:border-white/10 divide-x divide-gray-200 dark:divide-white/10 bg-gray-50 dark:bg-white/5">
                            {actions.map((action, i) => (
                                <button 
                                    key={i} 
                                    onClick={action.onClick}
                                    className={`py-3 text-sm font-medium hover:bg-black/5 dark:hover:bg-white/10 transition-colors ${action.danger ? 'text-apple-red' : 'text-apple-blue'}`}
                                >
                                    {action.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Complex Sub-Editors
        const IDEditor = ({ label, data, onChange }) => {
            const handleChange = (key, val) => onChange({ ...data, [key]: val });
            return (
                <Field label={label} className="p-4 bg-gray-100 dark:bg-white/5 rounded-2xl border border-transparent focus-within:border-apple-blue/30 transition-colors">
                    <div className="grid grid-cols-4 gap-2">
                        <Input value={data.route} onChange={v => handleChange('route', v)} placeholder="Route" />
                        <Input value={data.chapter} onChange={v => handleChange('chapter', v)} placeholder="Ch" />
                        <Input value={data.scene} onChange={v => handleChange('scene', v)} placeholder="Sc" />
                        <Input value={data.number} onChange={v => handleChange('number', v)} placeholder="No" />
                    </div>
                </Field>
            );
        };

        const StandingsEditor = ({ standings, onChange }) => {
            const safeList = Array.isArray(standings) ? standings : [];

            const updateItem = (idx, field, value) => {
                const newList = [...safeList];
                newList[idx] = { ...newList[idx], [field]: value };
                onChange(newList);
            };

            const addItem = () => {
                onChange([...safeList, { id: "", expression: "neutral", difference: "", position: "center", motion: "" }]);
            };

            const removeItem = (idx) => {
                onChange(safeList.filter((_, i) => i !== idx));
            };

            return (
                <Field label="Standings (Characters on Screen)">
                    <div className="space-y-3">
                        {safeList.map((item, idx) => (
                            <div key={idx} className="bg-white dark:bg-apple-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 animate-fade-in relative group">
                                <button onClick={() => removeItem(idx)} className="absolute top-2 right-2 text-apple-red hover:bg-red-50 dark:hover:bg-red-900/30 p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-all z-10" title="Remove">
                                    <Icon name="trash" />
                                </button>
                                <div className="grid grid-cols-12 gap-3 mb-2 pr-8">
                                    <div className="col-span-4">
                                        <label className="text-[10px] text-apple-300 font-mono mb-1 block">Char ID</label>
                                        <Input value={item.id} onChange={v => updateItem(idx, 'id', v)} placeholder="ID" />
                                    </div>
                                    <div className="col-span-4">
                                         <label className="text-[10px] text-apple-300 font-mono mb-1 block">Position</label>
                                         <Select value={item.position} onChange={v => updateItem(idx, 'position', v)} options={POSITIONS} className="py-2.5" />
                                    </div>
                                    <div className="col-span-4">
                                         <label className="text-[10px] text-apple-300 font-mono mb-1 block">Motion</label>
                                         <Input value={item.motion} onChange={v => updateItem(idx, 'motion', v)} placeholder="Motion" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                         <label className="text-[10px] text-apple-300 font-mono mb-1 block">Expression</label>
                                         <Input value={item.expression} onChange={v => updateItem(idx, 'expression', v)} placeholder="Expression" />
                                    </div>
                                    <div>
                                         <label className="text-[10px] text-apple-300 font-mono mb-1 block">Difference</label>
                                         <Input value={item.difference} onChange={v => updateItem(idx, 'difference', v)} placeholder="Diff" />
                                    </div>
                                </div>
                            </div>
                        ))}
                        <button onClick={addItem} className="w-full py-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-apple-400 hover:text-apple-blue hover:border-apple-blue hover:bg-apple-blue/5 transition-all text-sm font-medium flex items-center justify-center gap-2">
                            <Icon name="plus" weight="bold" /> Add Character
                        </button>
                    </div>
                </Field>
            );
        };

        const ChoicesEditor = ({ choices, onChange }) => {
            const safeChoices = Array.isArray(choices) ? choices : [];

            const updateChoice = (idx, field, value) => {
                const newChoices = [...safeChoices];
                newChoices[idx] = { ...newChoices[idx], [field]: value };
                onChange(newChoices);
            };

            const updateNextId = (idx, field, value) => {
                const newChoices = [...safeChoices];
                const currentNextId = newChoices[idx].nextId || { route: "", chapter: "", scene: "", number: "" };
                newChoices[idx] = { 
                    ...newChoices[idx], 
                    nextId: { ...currentNextId, [field]: value } 
                };
                onChange(newChoices);
            };

            const addChoice = () => {
                onChange([
                    ...safeChoices,
                    { 
                        text: "New Choice", 
                        nextId: { route: "", chapter: "", scene: "", number: "" } 
                    }
                ]);
            };

            const removeChoice = (indexToRemove) => {
                const newChoices = safeChoices.filter((_, i) => i !== indexToRemove);
                onChange(newChoices);
            };

            return (
                <Field label="Choices (Selections)">
                    <div className="space-y-3">
                        {safeChoices.map((choice, idx) => (
                            <div key={idx} className="bg-white dark:bg-apple-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 animate-fade-in relative group">
                                <button onClick={() => removeChoice(idx)} className="absolute top-2 right-2 text-apple-red hover:bg-red-50 dark:hover:bg-red-900/30 p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-all" title="Remove">
                                    <Icon name="trash" />
                                </button>
                                <div className="mb-2 pr-8">
                                    <label className="text-xs text-apple-300 font-mono mb-1 block">Option #{idx + 1}</label>
                                    <Input value={choice.text} onChange={v => updateChoice(idx, 'text', v)} placeholder="Choice Text" />
                                </div>
                                <div className="grid grid-cols-4 gap-2 mt-2 pt-2 border-t border-gray-100 dark:border-gray-700">
                                    <Input value={choice.nextId?.route || ''} onChange={v => updateNextId(idx, 'route', v)} placeholder="Rte" className="text-xs py-1.5" />
                                    <Input value={choice.nextId?.chapter || ''} onChange={v => updateNextId(idx, 'chapter', v)} placeholder="Ch" className="text-xs py-1.5" />
                                    <Input value={choice.nextId?.scene || ''} onChange={v => updateNextId(idx, 'scene', v)} placeholder="Sc" className="text-xs py-1.5" />
                                    <Input value={choice.nextId?.number || ''} onChange={v => updateNextId(idx, 'number', v)} placeholder="No" className="text-xs py-1.5" />
                                </div>
                            </div>
                        ))}
                        <button onClick={addChoice} className="w-full py-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-apple-400 hover:text-apple-blue hover:border-apple-blue hover:bg-apple-blue/5 transition-all text-sm font-medium flex items-center justify-center gap-2">
                            <Icon name="plus" weight="bold" /> Add Choice
                        </button>
                    </div>
                </Field>
            );
        };

        // --- Main Application ---
        const App = () => {
            const [scenarios, setScenarios] = useState([createEmptyScenario()]);
            const [selectedUuid, setSelectedUuid] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const [showJsonModal, setShowJsonModal] = useState(false);
            
            // Dialog State
            const [dialog, setDialog] = useState({ isOpen: false, title: "", message: "", actions: [] });

            // Initialize
            useEffect(() => {
                const isDark = localStorage.getItem('theme') === 'dark' || 
                             (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                setDarkMode(isDark);

                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        const validated = parsed.map(s => s._uuid ? s : {...s, _uuid: crypto.randomUUID()});
                        setScenarios(validated);
                    } catch (e) { console.error("Load failed", e); }
                }
            }, []);

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [darkMode]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(scenarios));
            }, [scenarios]);

            useEffect(() => {
                if (!selectedUuid && scenarios.length > 0) {
                    setSelectedUuid(scenarios[0]._uuid);
                }
            }, [scenarios, selectedUuid]);

            const selectedScenario = useMemo(() => 
                scenarios.find(s => s._uuid === selectedUuid) || scenarios[0]
            , [scenarios, selectedUuid]);

            // Handlers
            const handleUpdate = (newScenario) => {
                setScenarios(prev => prev.map(s => s._uuid === newScenario._uuid ? newScenario : s));
            };

            const handleAdd = () => {
                const newScn = createEmptyScenario(scenarios.length);
                setScenarios([...scenarios, newScn]);
                setSelectedUuid(newScn._uuid);
            };

            const handleDuplicate = () => {
                if (!selectedScenario) return;
                const clone = JSON.parse(JSON.stringify(selectedScenario));
                clone._uuid = crypto.randomUUID();
                clone.id.number = String(Number(clone.id.number) + 1).padStart(3, '0');
                
                const idx = scenarios.findIndex(s => s._uuid === selectedUuid);
                const newScenarios = [...scenarios];
                newScenarios.splice(idx + 1, 0, clone);
                setScenarios(newScenarios);
                setSelectedUuid(clone._uuid);
            };

            const closeDialog = () => setDialog(prev => ({ ...prev, isOpen: false }));

            const handleDelete = (uuid) => {
                if (scenarios.length <= 1) return;
                
                setDialog({
                    isOpen: true,
                    title: "Delete Scene?",
                    message: "This action cannot be undone.",
                    actions: [
                        { label: "Cancel", onClick: closeDialog },
                        { label: "Delete", danger: true, onClick: () => {
                            const newScenarios = scenarios.filter(s => s._uuid !== uuid);
                            setScenarios(newScenarios);
                            if (selectedUuid === uuid) setSelectedUuid(newScenarios[0]._uuid);
                            closeDialog();
                        }}
                    ]
                });
            };

            const handleDownload = () => {
                const exportData = scenarios.map(({_uuid, ...rest}) => rest);
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `scenario_data_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        const arr = Array.isArray(json) ? json : [json];
                        const imported = arr.map(s => ({ ...s, _uuid: crypto.randomUUID() }));
                        setScenarios(imported);
                        setSelectedUuid(imported[0]._uuid);
                    } catch (err) {
                        setDialog({
                            isOpen: true,
                            title: "Error",
                            message: "Invalid JSON file.",
                            actions: [{ label: "OK", onClick: closeDialog }]
                        });
                    }
                };
                reader.readAsText(file);
                e.target.value = null; // Reset input
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text);
                setDialog({
                    isOpen: true,
                    title: "Copied!",
                    message: "JSON data copied to clipboard.",
                    actions: [{ label: "OK", onClick: closeDialog }]
                });
            };

            // Filter Scenarios
            const filteredScenarios = scenarios.filter(s => 
                s.text.toLowerCase().includes(searchTerm.toLowerCase()) || 
                s.id.number.includes(searchTerm)
            );

            return (
                <div className="flex h-screen w-full bg-white dark:bg-apple-600 overflow-hidden">
                    
                    {/* --- Sidebar --- */}
                    <aside className="w-80 flex-shrink-0 bg-apple-50 dark:bg-apple-700/50 border-r border-gray-200 dark:border-white/5 flex flex-col z-20">
                        <div className="h-16 flex items-center px-4 border-b border-gray-200 dark:border-white/5 shrink-0 glass sticky top-0 z-10">
                            <Icon name="book-open-text" className="text-xl text-apple-blue mr-2" weight="duotone"/>
                            <h1 className="font-bold text-lg tracking-tight">Scenario<span className="text-apple-blue">Kit</span></h1>
                            <div className="ml-auto flex gap-2">
                                <button onClick={handleDuplicate} className="p-2 hover:bg-white dark:hover:bg-white/10 rounded-lg transition-colors text-apple-500 dark:text-apple-200" title="Duplicate Current">
                                    <Icon name="copy" />
                                </button>
                                <button onClick={handleAdd} className="p-2 bg-apple-blue text-white rounded-lg shadow-lg shadow-apple-blue/30 hover:bg-blue-600 transition-all">
                                    <Icon name="plus" weight="bold"/>
                                </button>
                            </div>
                        </div>

                        <div className="p-3">
                            <div className="relative">
                                <Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                                <input 
                                    type="text" 
                                    placeholder="Search scene..." 
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    className="w-full bg-gray-200/50 dark:bg-black/20 border-none rounded-xl pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-apple-blue/50 outline-none transition-all"
                                />
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-3 space-y-2">
                            {filteredScenarios.map(s => (
                                <div 
                                    key={s._uuid}
                                    onClick={() => setSelectedUuid(s._uuid)}
                                    className={`group relative p-3 rounded-xl cursor-pointer transition-all duration-200 border ${selectedUuid === s._uuid 
                                        ? 'bg-white dark:bg-apple-600 border-apple-blue/30 shadow-md ring-1 ring-apple-blue/20' 
                                        : 'hover:bg-white/60 dark:hover:bg-white/5 border-transparent'}`}
                                >
                                    <div className="flex justify-between items-start mb-1">
                                        <span className={`text-[10px] font-bold font-mono tracking-tight px-1.5 py-0.5 rounded-md ${selectedUuid === s._uuid ? 'bg-apple-blue text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400'}`}>
                                            {`${s.id.route}_${s.id.chapter}-${s.id.scene}_${s.id.number}`}
                                        </span>
                                    </div>
                                    <div className={`text-sm font-medium line-clamp-2 mb-1 ${selectedUuid === s._uuid ? 'text-apple-blue dark:text-blue-400' : ''}`}>
                                        {s.text ? s.text : <span className="text-gray-400 italic text-xs">テキストなし</span>}
                                    </div>
                                    <div className="flex justify-between items-center text-xs text-gray-400">
                                        <span>{s.displayName}</span>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); handleDelete(s._uuid); }}
                                            className="opacity-0 group-hover:opacity-100 hover:text-red-500 transition-opacity p-1"
                                        >
                                            <Icon name="trash" />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="p-4 border-t border-gray-200 dark:border-white/5 text-xs text-center text-gray-400">
                            {scenarios.length} Scenes Total
                        </div>
                    </aside>

                    {/* --- Main Editor Area --- */}
                    <main className="flex-1 flex flex-col h-full bg-white dark:bg-apple-600 relative overflow-hidden">
                        {/* Header */}
                        <header className="h-16 flex items-center justify-between px-6 border-b border-gray-100 dark:border-white/5 glass z-10 sticky top-0">
                            <div className="flex items-center gap-4 text-sm text-gray-500">
                                <div className="flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    <span>Auto-saved</span>
                                </div>
                            </div>

                            <div className="flex items-center gap-3">
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 rounded-full transition-colors">
                                    <Icon name={darkMode ? "sun" : "moon"} weight="fill" className="text-xl" />
                                </button>
                                <div className="h-6 w-px bg-gray-200 dark:bg-white/10"></div>
                                
                                <label className="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 cursor-pointer text-sm font-medium text-apple-500 dark:text-apple-200 transition-colors">
                                    <Icon name="upload-simple" />
                                    Import
                                    <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                </label>
                                
                                <button onClick={() => setShowJsonModal(true)} className="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-sm font-medium text-apple-500 dark:text-apple-200 transition-colors">
                                    <Icon name="code" /> JSON
                                </button>

                                <button onClick={handleDownload} className="flex items-center gap-2 px-4 py-2 bg-apple-500 dark:bg-white text-white dark:text-black rounded-full text-sm font-semibold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all">
                                    <Icon name="download-simple" weight="bold" />
                                    Export
                                </button>
                            </div>
                        </header>

                        {/* Scrollable Form Area */}
                        <div className="flex-1 overflow-y-auto p-8 pb-32">
                            <div className="max-w-5xl mx-auto space-y-8 animate-fade-in">
                                
                                {/* Section: IDs */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <IDEditor 
                                        label="Current ID" 
                                        data={selectedScenario.id} 
                                        onChange={v => handleUpdate({...selectedScenario, id: v})} 
                                    />
                                    <IDEditor 
                                        label="Next ID (Jump Target)" 
                                        data={selectedScenario.next_id} 
                                        onChange={v => handleUpdate({...selectedScenario, next_id: v})} 
                                    />
                                </div>

                                {/* Section: Character & Dialogue */}
                                <div className="glass rounded-3xl p-6 border border-gray-100 dark:border-white/5 shadow-sm">
                                    <div className="flex items-center gap-2 mb-4 text-apple-blue">
                                        <Icon name="chat-circle-text" weight="duotone" className="text-xl"/>
                                        <h3 className="font-bold text-lg">Dialogue</h3>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <Field label="Char ID (Talker)">
                                            <Input 
                                                value={selectedScenario.characterId} 
                                                onChange={v => handleUpdate({...selectedScenario, characterId: v})} 
                                                placeholder="e.g. shiroko"
                                            />
                                        </Field>
                                        <Field label="Display Name">
                                            <Input 
                                                value={selectedScenario.displayName} 
                                                onChange={v => handleUpdate({...selectedScenario, displayName: v})} 
                                                placeholder="e.g. シロコ"
                                            />
                                        </Field>
                                    </div>

                                    <Field label="Text Body">
                                        <textarea 
                                            value={selectedScenario.text}
                                            onChange={e => handleUpdate({...selectedScenario, text: e.target.value})}
                                            className="w-full h-32 bg-gray-50 dark:bg-apple-800/50 border border-gray-200 dark:border-white/5 focus:border-apple-blue focus:ring-4 focus:ring-apple-blue/10 rounded-2xl p-4 text-base leading-relaxed resize-none outline-none transition-all shadow-inner"
                                            placeholder="Write the dialogue here..."
                                        />
                                    </Field>
                                </div>

                                {/* Section: Standings (New) */}
                                <StandingsEditor 
                                    standings={selectedScenario.standings} 
                                    onChange={v => handleUpdate({...selectedScenario, standings: v})} 
                                />

                                {/* Section: Environment */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="glass rounded-3xl p-6 border border-gray-100 dark:border-white/5 shadow-sm">
                                        <div className="flex items-center gap-2 mb-4 text-purple-500">
                                            <Icon name="image" weight="duotone" className="text-xl"/>
                                            <h3 className="font-bold text-lg">Background</h3>
                                        </div>
                                        <div className="space-y-3">
                                            <Field label="Location">
                                                <Input value={selectedScenario.bg.location} onChange={v => handleUpdate({...selectedScenario, bg: {...selectedScenario.bg, location: v}})} />
                                            </Field>
                                            <div className="grid grid-cols-2 gap-3">
                                                <Field label="Time">
                                                    <Select value={selectedScenario.bg.time} onChange={v => handleUpdate({...selectedScenario, bg: {...selectedScenario.bg, time: v}})} 
                                                        options={TIMES}
                                                    />
                                                </Field>
                                                <Field label="Lighting">
                                                    <Select value={selectedScenario.bg.light} onChange={v => handleUpdate({...selectedScenario, bg: {...selectedScenario.bg, light: v}})} 
                                                        options={LIGHTS}
                                                    />
                                                </Field>
                                            </div>
                                            <Field label="Detail">
                                                <Input value={selectedScenario.bg.detail} onChange={v => handleUpdate({...selectedScenario, bg: {...selectedScenario.bg, detail: v}})} />
                                            </Field>
                                        </div>
                                    </div>

                                    <div className="glass rounded-3xl p-6 border border-gray-100 dark:border-white/5 shadow-sm">
                                        <div className="flex items-center gap-2 mb-4 text-orange-500">
                                            <Icon name="sliders-horizontal" weight="duotone" className="text-xl"/>
                                            <h3 className="font-bold text-lg">System</h3>
                                        </div>
                                        <div className="space-y-3">
                                            <div className="grid grid-cols-2 gap-3">
                                                <Field label="BGM">
                                                    <Input value={selectedScenario.bgm} onChange={v => handleUpdate({...selectedScenario, bgm: v})} placeholder="music_id" />
                                                </Field>
                                                <Field label="SE">
                                                    <Input value={selectedScenario.se} onChange={v => handleUpdate({...selectedScenario, se: v})} placeholder="sound_id" />
                                                </Field>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <Field label="Duration (sec)">
                                                    <Input type="number" value={selectedScenario.seconds} onChange={v => handleUpdate({...selectedScenario, seconds: Number(v)})} />
                                                </Field>
                                                <Field label="Transition">
                                                    <Input value={selectedScenario.transition} onChange={v => handleUpdate({...selectedScenario, transition: v})} placeholder="fade" />
                                                </Field>
                                            </div>
                                             <Field label="Type">
                                                <Select value={selectedScenario.type} onChange={v => handleUpdate({...selectedScenario, type: v})} 
                                                    options={TYPES}
                                                />
                                            </Field>
                                        </div>
                                    </div>
                                </div>

                                {/* Section: Choices */}
                                <ChoicesEditor choices={selectedScenario.choices} onChange={v => handleUpdate({...selectedScenario, choices: v})} />

                                <div className="h-12"></div>
                            </div>
                        </div>

                    </main>

                    {/* JSON Modal */}
                    {showJsonModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in" onClick={() => setShowJsonModal(false)}>
                            <div className="bg-white dark:bg-apple-700 w-full max-w-2xl max-h-[80vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col animate-scale-in" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 dark:border-white/10 flex justify-between items-center bg-gray-50 dark:bg-white/5">
                                    <h3 className="font-bold text-apple-500 dark:text-white">Raw JSON Preview</h3>
                                    <button onClick={() => {
                                        const json = JSON.stringify(scenarios.map(({_uuid, ...rest}) => rest), null, 2);
                                        copyToClipboard(json);
                                    }} className="text-apple-blue text-sm font-medium hover:underline">Copy All</button>
                                </div>
                                <div className="flex-1 overflow-auto p-4 bg-white dark:bg-black/30">
                                    <pre className="text-xs font-mono text-gray-600 dark:text-gray-300 whitespace-pre-wrap break-all">
                                        {JSON.stringify(scenarios.map(({_uuid, ...r}) => r), null, 2)}
                                    </pre>
                                </div>
                                <div className="p-4 border-t border-gray-100 dark:border-white/10 text-right bg-gray-50 dark:bg-white/5">
                                    <button onClick={() => setShowJsonModal(false)} className="px-6 py-2 bg-gray-200 dark:bg-white/10 hover:bg-gray-300 dark:hover:bg-white/20 rounded-full text-sm font-medium transition-colors text-apple-500 dark:text-white">Close</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Custom Alert/Confirm Modal */}
                    <Modal 
                        isOpen={dialog.isOpen} 
                        onClose={closeDialog} 
                        title={dialog.title} 
                        actions={dialog.actions}
                    >
                        {dialog.message}
                    </Modal>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>